// frontend-ui/src/SettingsPanel.tsx
/**
 * è®¾ç½®é¢æ¿ç»„ä»¶ - é‡æ–°è®¾è®¡ç‰ˆæœ¬
 * ç»Ÿä¸€ç®¡ç† AI æ¨¡å‹ã€å‘é‡åŒ–ã€ç³»ç»Ÿé…ç½®ç­‰æ‰€æœ‰è®¾ç½®
 */

import { useState, useEffect, useCallback } from 'react';
import {
  Settings,
  Cpu,
  Database,
  FileText,
  Globe,
  CheckCircle2,
  XCircle,
  Loader2,
  ChevronRight,
  ChevronDown,
  RefreshCw,
  AlertTriangle,
  Check,
  X,
  Zap,
  Server,
  Sliders,
  Save,
  Info,
  Edit3,
  TestTube,
  Sparkles,
  HardDrive,
  FolderOpen,
  Tag,
  Plus,
} from 'lucide-react';
import useSettingsStore from './store/settingsStore';
import { open } from '@tauri-apps/plugin-dialog';
import type { ModelProvider, AnnotationConfig, VectorizationConfig } from './types/settings';

// ==================== å­ç»„ä»¶ ====================

interface SettingsSectionProps {
  title: string;
  icon: React.ReactNode;
  children: React.ReactNode;
  description?: string;
  badge?: string;
  badgeColor?: string;
  action?: React.ReactNode;
  allowOverflow?: boolean;
}

function SettingsSection({ title, icon, children, description, badge, badgeColor = 'blue', action, allowOverflow = false }: SettingsSectionProps) {
  return (
    <div className={`bg-[#151515] rounded-xl border border-white/5 ${allowOverflow ? 'overflow-visible' : 'overflow-hidden'}`}>
      <div className="px-5 py-4 border-b border-white/5 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="text-blue-400">{icon}</div>
          <div>
            <h3 className="font-medium text-white">{title}</h3>
            {description && <p className="text-xs text-gray-500 mt-0.5">{description}</p>}
          </div>
        </div>
        <div className="flex items-center gap-2">
          {badge && (
            <span className={`text-xs px-2 py-0.5 rounded bg-${badgeColor}-500/20 text-${badgeColor}-400`}>
              {badge}
            </span>
          )}
          {action}
        </div>
      </div>
      <div className="p-5">{children}</div>
    </div>
  );
}

// ä¸‹æ‹‰é€‰æ‹©ç»„ä»¶
interface SelectDropdownProps {
  label: string;
  value: string;
  options: Array<{ id: string; name: string; description?: string }>;
  onChange: (value: string) => void;
  placeholder?: string;
  disabled?: boolean;
}

function SelectDropdown({ label, value, options, onChange, placeholder = 'è¯·é€‰æ‹©', disabled }: SelectDropdownProps) {
  const [isOpen, setIsOpen] = useState(false);
  const selected = options.find(o => o.id === value);
  
  return (
    <div className="relative">
      <label className="text-xs text-gray-500 mb-1.5 block">{label}</label>
      <button
        onClick={() => !disabled && setIsOpen(!isOpen)}
        disabled={disabled}
        className={`w-full flex items-center justify-between px-3 py-2.5 bg-[#1a1a1a] border border-white/10 rounded-lg text-sm transition-colors ${
          disabled ? 'opacity-50 cursor-not-allowed' : 'hover:border-white/20'
        }`}
      >
        <span className={selected ? 'text-white' : 'text-gray-500'}>
          {selected?.name || placeholder}
        </span>
        <ChevronDown size={16} className={`text-gray-400 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
      </button>
      
      {isOpen && (
        <>
          <div className="fixed inset-0 z-10" onClick={() => setIsOpen(false)} />
          <div className="absolute z-20 top-full left-0 right-0 mt-1 bg-[#1a1a1a] border border-white/10 rounded-lg shadow-xl max-h-60 overflow-y-auto custom-scrollbar">
            {options.length > 0 ? options.map((option) => (
              <button
                key={option.id}
                onClick={() => {
                  onChange(option.id);
                  setIsOpen(false);
                }}
                className={`w-full flex items-center justify-between px-3 py-2.5 text-left text-sm transition-colors hover:bg-white/5 ${
                  value === option.id ? 'bg-blue-500/10 text-blue-400' : 'text-gray-300'
                }`}
              >
                <div>
                  <div className="font-medium">{option.name}</div>
                  {option.description && (
                    <div className="text-xs text-gray-500 mt-0.5">{option.description}</div>
                  )}
                </div>
                {value === option.id && <Check size={14} className="text-blue-400" />}
              </button>
            )) : (
              <div className="px-3 py-4 text-center text-gray-500 text-sm">æš‚æ— å¯é€‰é¡¹</div>
            )}
          </div>
        </>
      )}
    </div>
  );
}

// å¯¼èˆªé¡¹ç»„ä»¶
interface SettingsNavItemProps {
  icon: React.ReactNode;
  label: string;
  active?: boolean;
  onClick?: () => void;
  badge?: number;
}

function SettingsNavItem({ icon, label, active, onClick, badge }: SettingsNavItemProps) {
  return (
    <button
      onClick={onClick}
      className={`w-full flex items-center justify-between px-4 py-3 rounded-xl transition-all ${
        active
          ? 'bg-blue-600 text-white shadow-lg shadow-blue-600/30'
          : 'text-gray-400 hover:text-white hover:bg-white/5'
      }`}
    >
      <div className="flex items-center gap-3">
        {icon}
        <span className="text-sm font-medium">{label}</span>
      </div>
      <div className="flex items-center gap-2">
        {badge !== undefined && badge > 0 && (
          <span className={`text-[10px] px-1.5 py-0.5 rounded-full ${
            active ? 'bg-white/20' : 'bg-yellow-500 text-black font-bold'
          }`}>
            {badge}
          </span>
        )}
        <ChevronRight size={14} className="opacity-50" />
      </div>
    </button>
  );
}

// ==================== ä¸»ç»„ä»¶ ====================

type SettingsTab = 'llm' | 'embedding' | 'vectordb' | 'prompt' | 'system';

// æ··å‰ªæ ‡ç­¾é…ç½®ç±»å‹
interface MashupConfig {
  version: string;
  primary_functions: string[];
  style_effects: string[];
  connection_types: string[];
  editing_rhythms: string[];
  sound_effects: string[];
}

const DEFAULT_MASHUP_CONFIG: MashupConfig = {
  version: "v4.0-mashup-optimized",
  primary_functions: [
    "å¼ºè¡Œè§£é‡Š", "èº«ä»½åè½¬", "åœºæ™¯å«æ¥", "é‡‘å¥å¼•ç”¨", 
    "è·¨æœèŠå¤©", "åå·®èŒ", "ä¸€æœ¬æ­£ç»èƒ¡è¯´", "é™ç»´æ‰“å‡»",
    "æ—¶ä»£é”™ä½", "æ¬¡å…ƒçªç ´", "ç¥è½¬æŠ˜", "åºŸè¯æ–‡å­¦"
  ],
  style_effects: [
    "åè®½é«˜çº§é»‘", "è‡ªå˜²è§£æ„", "è°éŸ³æ¢—ç‹", "åŒå…³å¤§å¸ˆ",
    "å¤¸å¼ æ¯”å–»", "æ­£è¯åè¯´", "æ— æ•ˆæ²Ÿé€š", "èœœæ±è‡ªä¿¡",
    "å¼±å°å¯æ€œ", "åš£å¼ è·‹æ‰ˆ", "å‚²å¨‡å£å«Œ", "å‡¡å°”èµ›æ–‡å­¦"
  ],
  connection_types: [
    "æ¥åè½¬", "æ¥è´¨ç–‘", "æ¥è‡ªå˜²", "æ¥ç©æ¢—",
    "æ¥å†·åœº", "æ¥çˆ†å‘", "æ¥è§£é‡Š", "æ¥åæ§½",
    "æ¥æ±‚é¥¶", "æ¥å‚²å¨‡", "æ¥è£…å‚»", "æ¥æš´æ€’"
  ],
  editing_rhythms: [
    "å¿«é€Ÿåˆ‡æ¢—", "æ…¢æ”¾æ‰“è„¸", "é‡å¤é¬¼ç•œ", "æˆ›ç„¶è€Œæ­¢",
    "é€’è¿›å¤¸å¼ ", "çªç„¶æ‰“æ–­", "ç”»å¤–éŸ³æ€¼", "ç”»é¢ç¥é…"
  ],
  sound_effects: [
    "å˜é€Ÿå¤„ç†", "å›å£°æ•ˆæœ", "æ··å“å¤„ç†", "ç”µå­å˜å£°",
    "ç¯å¢ƒéŸ³çªæ˜¾", "BGMéª¤åœ", "éŸ³æ•ˆå åŠ ", "é™éŸ³åå·®"
  ]
};

export default function SettingsPanel() {
  const [activeTab, setActiveTab] = useState<SettingsTab>('llm');
  const [showConfigEditor, setShowConfigEditor] = useState(false);
  const [configEditorContent, setConfigEditorContent] = useState('');
  const [configEditorType, setConfigEditorType] = useState<'llm' | 'embedding' | 'vectordb' | 'prompt' | 'mashup'>('llm');
  
  // æ¨¡å‹é€‰æ‹©çŠ¶æ€
  const [selectedProviderType, setSelectedProviderType] = useState<'local' | 'commercial' | 'cloud'>('local');
  const [selectedLocalMode, setSelectedLocalMode] = useState<string>('ollama');
  const [selectedLocalModel, setSelectedLocalModel] = useState<string>('');
  const [selectedCommercialModel, setSelectedCommercialModel] = useState<string>('');
  
  // Embedding è¿æ¥æµ‹è¯•çŠ¶æ€ï¼ˆç‹¬ç«‹äºLLMï¼‰
  const [embeddingConnectionStatus, setEmbeddingConnectionStatus] = useState<{
    status: 'idle' | 'testing' | 'connected' | 'failed';
    error?: string;
  }>({ status: 'idle' });
  
  // æç¤ºè¯é¢„è§ˆçŠ¶æ€
  const [showPromptPreview, setShowPromptPreview] = useState<'system' | 'user' | null>(null);
  
  // å‘é‡åŒ–æ¨¡å‹é€‰æ‹©
  const [selectedEmbeddingProviderType, setSelectedEmbeddingProviderType] = useState<'local' | 'commercial' | 'cloud'>('local');
  const [selectedEmbeddingLocalMode, setSelectedEmbeddingLocalMode] = useState<string>('ollama');
  const [selectedEmbeddingLocalModel, setSelectedEmbeddingLocalModel] = useState<string>('');
  const [selectedEmbeddingCommercialModel, setSelectedEmbeddingCommercialModel] = useState<string>('');
  
  // æ··å‰ªæ ‡ç­¾é…ç½®
  const [mashupConfig, setMashupConfig] = useState<MashupConfig>(DEFAULT_MASHUP_CONFIG);
  const [editingTagCategory, setEditingTagCategory] = useState<string | null>(null);
  const [newTag, setNewTag] = useState('');
  const [annotationDraft, setAnnotationDraft] = useState<AnnotationConfig | null>(null);
  const [vectorizationDraft, setVectorizationDraft] = useState<VectorizationConfig | null>(null);
  
  // æ¨¡å‹ç®¡ç†å¼¹çª—çŠ¶æ€
  const [showProviderEditor, setShowProviderEditor] = useState(false);
  const [editingProvider, setEditingProvider] = useState<Partial<ModelProvider> | null>(null);
  const [providerEditorCategory, setProviderEditorCategory] = useState<'llm' | 'embedding'>('llm');
  
  const {
    llmProviders,
    embeddingProviders,
    activeLLMProvider,
    activeEmbeddingProvider,
    llmConnectionStatus,
    annotationConfig,
    vectorizationConfig,
    appSettings,
    pathConfig,
    vectorDB,
    isLoading,
    isSaving,
    error,
    promptConfigRaw,
    loadAllSettings,
    loadSettingsSections,
    loadLLMProviders,
    loadEmbeddingProviders,
    loadLLMConfigRaw,
    loadEmbeddingConfigRaw,
    loadPromptConfig,
    setActiveLLMProvider,
    setActiveEmbeddingProvider,
    testLLMConnection,
    saveLLMConfig,
    saveEmbeddingConfig,
    savePromptConfig,
    saveAnnotationConfig,
    saveVectorizationConfig,
    setError,
    createProvider,
    updateProvider: updateProviderInDB,
    deleteProvider,
    resetProviderDefaults,
  } = useSettingsStore();
  
  // åˆå§‹åŠ è½½
  useEffect(() => {
    loadAllSettings();
  }, []);
  
  // åŒæ­¥é€‰ä¸­çŠ¶æ€
  useEffect(() => {
    if (activeLLMProvider && llmProviders.length > 0) {
      const provider = llmProviders.find(p => p.id === activeLLMProvider);
      if (provider) {
        const nextType = provider.provider_type === 'commercial'
          ? (selectedProviderType === 'cloud' ? 'cloud' : 'commercial')
          : 'local';
        setSelectedProviderType(nextType);
        if (provider.provider_type === 'local') {
          setSelectedLocalMode(provider.local_mode || 'ollama');
          setSelectedLocalModel(provider.id);
        } else {
          setSelectedCommercialModel(provider.id);
        }
      }
    }
  }, [activeLLMProvider, llmProviders]);

  // åŒæ­¥ Embedding é€‰ä¸­çŠ¶æ€
  useEffect(() => {
    if (activeEmbeddingProvider && embeddingProviders.length > 0) {
      const provider = embeddingProviders.find(p => p.id === activeEmbeddingProvider);
      if (provider) {
        const nextType = provider.provider_type === 'commercial'
          ? (selectedEmbeddingProviderType === 'cloud' ? 'cloud' : 'commercial')
          : 'local';
        setSelectedEmbeddingProviderType(nextType);
        if (provider.provider_type === 'local') {
          setSelectedEmbeddingLocalMode(provider.local_mode || 'ollama');
          setSelectedEmbeddingLocalModel(provider.id);
        } else {
          setSelectedEmbeddingCommercialModel(provider.id);
        }
      }
    }
  }, [activeEmbeddingProvider, embeddingProviders]);

  // åŒæ­¥æ ‡æ³¨å‚æ•°è‰ç¨¿
  useEffect(() => {
    if (annotationConfig && annotationConfig._loaded) {
      setAnnotationDraft(annotationConfig);
    }
  }, [annotationConfig]);

  // åŒæ­¥å‘é‡åŒ–å‚æ•°è‰ç¨¿
  useEffect(() => {
    if (vectorizationConfig && vectorizationConfig._loaded) {
      setVectorizationDraft(vectorizationConfig);
    }
  }, [vectorizationConfig]);

  // åˆ‡æ¢åˆ°å‘é‡åŒ–æ¨¡å‹é¡µæ—¶åˆ·æ–°åˆ—è¡¨
  useEffect(() => {
    if (activeTab === 'embedding') {
      loadEmbeddingProviders();
    }
  }, [activeTab, loadEmbeddingProviders]);
  
  // å¤„ç†æ¨¡å‹é€‰æ‹©
  const handleSelectProvider = useCallback(async (providerId: string) => {
    setActiveLLMProvider(providerId);
    await testLLMConnection(providerId);
  }, [setActiveLLMProvider, testLLMConnection]);

  const handleSelectEmbeddingProvider = useCallback(async (providerId: string) => {
    await setActiveEmbeddingProvider(providerId);
    await testEmbeddingConnection();
  }, [setActiveEmbeddingProvider]);

  const handleAnnotationDraftChange = (patch: Partial<AnnotationConfig>) => {
    setAnnotationDraft(prev => ({ ...(prev ?? annotationConfig), ...patch }));
  };

  const handleSaveAnnotationConfig = async () => {
    if (!annotationDraft) return;
    await saveAnnotationConfig(annotationDraft);
    await loadSettingsSections();
  };

  const annotationHasChanges = !!annotationDraft && annotationConfig._loaded && (
    annotationDraft.batch_size !== annotationConfig.batch_size ||
    annotationDraft.concurrent_requests !== annotationConfig.concurrent_requests ||
    annotationDraft.max_retries !== annotationConfig.max_retries ||
    annotationDraft.save_interval !== annotationConfig.save_interval ||
    annotationDraft.retry_delay !== annotationConfig.retry_delay
  );

  const handleVectorizationDraftChange = (patch: Partial<VectorizationConfig>) => {
    setVectorizationDraft(prev => ({ ...(prev ?? vectorizationConfig), ...patch }));
  };

  const handleSaveVectorizationConfig = async () => {
    if (!vectorizationDraft) return;
    await saveVectorizationConfig(vectorizationDraft);
    await loadSettingsSections();
  };

  const vectorizationHasChanges = !!vectorizationDraft && vectorizationConfig._loaded && (
    vectorizationDraft.batch_size !== vectorizationConfig.batch_size ||
    vectorizationDraft.concurrent_requests !== vectorizationConfig.concurrent_requests ||
    vectorizationDraft.max_retries !== vectorizationConfig.max_retries ||
    vectorizationDraft.retry_delay !== vectorizationConfig.retry_delay
  );
  
  // æµ‹è¯• Embedding è¿æ¥
  const testEmbeddingConnection = async () => {
    const providerId = selectedEmbeddingProviderType === 'local' 
      ? selectedEmbeddingLocalModel 
      : selectedEmbeddingCommercialModel;
    
    if (!providerId) return;
    
    setEmbeddingConnectionStatus({ status: 'testing' });
    try {
      const res = await fetch('http://127.0.0.1:8000/api/model-providers/test-connection', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ provider_id: providerId })
      });
      const result = await res.json();
      
      if (result.success) {
        setEmbeddingConnectionStatus({ 
          status: 'connected',
          error: undefined
        });
      } else {
        setEmbeddingConnectionStatus({ 
          status: 'failed', 
          error: result.message || 'è¿æ¥å¤±è´¥' 
        });
      }
    } catch (e: any) {
      setEmbeddingConnectionStatus({ 
        status: 'failed', 
        error: e.message || 'ç½‘ç»œé”™è¯¯' 
      });
    }
  };
  
  // æ‰“å¼€é…ç½®ç¼–è¾‘å™¨
  const openConfigEditor = async (type: 'llm' | 'embedding' | 'vectordb' | 'prompt' | 'mashup') => {
    setConfigEditorType(type);
    
    if (type === 'llm' || type === 'vectordb') {
      const content = await loadLLMConfigRaw();
      setConfigEditorContent(content);
    } else if (type === 'embedding') {
      const content = await loadEmbeddingConfigRaw();
      setConfigEditorContent(content);
    } else if (type === 'prompt') {
      await loadPromptConfig();
      setConfigEditorContent(promptConfigRaw);
    } else {
      setConfigEditorContent(JSON.stringify(mashupConfig, null, 2));
    }
    
    setShowConfigEditor(true);
  };
  
  // ä¿å­˜é…ç½®
  const handleSaveConfig = async () => {
    let success = false;
    
    if (configEditorType === 'llm' || configEditorType === 'vectordb') {
      success = await saveLLMConfig(configEditorContent);
    } else if (configEditorType === 'embedding') {
      success = await saveEmbeddingConfig(configEditorContent);
    } else if (configEditorType === 'prompt') {
      success = await savePromptConfig(configEditorContent);
    } else {
      try {
        const parsed = JSON.parse(configEditorContent);
        setMashupConfig(parsed);
        success = true;
      } catch {
        setError('JSON æ ¼å¼é”™è¯¯');
        return;
      }
    }
    
    if (success) {
      setShowConfigEditor(false);
      if (configEditorType === 'embedding') {
        await loadEmbeddingProviders();
      } else {
        await loadLLMProviders();
      }
    }
  };
  
  // é€‰æ‹©æ–‡ä»¶å¤¹
  const handleSelectFolder = async (key: string) => {
    try {
      const selected = await open({
        directory: true,
        multiple: false,
        title: 'é€‰æ‹©æ–‡ä»¶å¤¹'
      });
      if (selected) {
        console.log(`Selected folder for ${key}:`, selected);
        // TODO: ä¿å­˜è·¯å¾„åˆ°åç«¯
      }
    } catch (e) {
      console.error('Failed to select folder:', e);
    }
  };
  
  // ==================== æ¨¡å‹ç®¡ç† CRUD ====================
  
  const handleOpenAddProvider = (category: 'llm' | 'embedding') => {
    setProviderEditorCategory(category);
    setEditingProvider({
      name: '',
      category,
      provider_type: 'commercial',
      local_mode: '',
      base_url: '',
      model: '',
      api_key: '',
      max_tokens: category === 'llm' ? 2000 : 0,
      temperature: category === 'llm' ? 0.7 : 0,
      timeout: 60,
      dimension: category === 'embedding' ? 1024 : 0,
      api_style: 'openai',
      description: '',
      price_info: '',
    });
    setShowProviderEditor(true);
  };
  
  const handleOpenEditProvider = (provider: ModelProvider) => {
    setProviderEditorCategory(provider.category);
    setEditingProvider({ ...provider });
    setShowProviderEditor(true);
  };
  
  const handleSaveProvider = async () => {
    if (!editingProvider || !editingProvider.name || !editingProvider.base_url) {
      setError('è¯·å¡«å†™æ¨¡å‹åç§°å’Œ API åœ°å€');
      return;
    }
    
    if (editingProvider.id) {
      // ç¼–è¾‘å·²æœ‰
      const { id, ...data } = editingProvider;
      await updateProviderInDB(id, data);
    } else {
      // æ–°å»º
      await createProvider(editingProvider);
    }
    
    setShowProviderEditor(false);
    setEditingProvider(null);
  };
  
  const handleDeleteProvider = async (id: string, name: string) => {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡å‹ã€Œ${name}ã€å—ï¼Ÿ`)) return;
    await deleteProvider(id);
  };
  
  const handleResetDefaults = async () => {
    if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ¨¡å‹ä¸ºé»˜è®¤é…ç½®ï¼Ÿç”¨æˆ·æ·»åŠ çš„æ¨¡å‹å°†è¢«åˆ é™¤ã€‚')) return;
    await resetProviderDefaults();
  };
  
  // æ·»åŠ æ ‡ç­¾
  const handleAddTag = (category: keyof MashupConfig) => {
    if (!newTag.trim()) return;
    const current = mashupConfig[category];
    if (Array.isArray(current) && !current.includes(newTag.trim())) {
      setMashupConfig({
        ...mashupConfig,
        [category]: [...current, newTag.trim()]
      });
    }
    setNewTag('');
    setEditingTagCategory(null);
  };
  
  // åˆ é™¤æ ‡ç­¾
  const handleRemoveTag = (category: keyof MashupConfig, tag: string) => {
    const current = mashupConfig[category];
    if (Array.isArray(current)) {
      setMashupConfig({
        ...mashupConfig,
        [category]: current.filter(t => t !== tag)
      });
    }
  };
  
  // è®¡ç®—ç»Ÿè®¡
  const localProviders = llmProviders.filter(p => p.provider_type === 'local');
  const commercialProviders = llmProviders.filter(p => p.provider_type === 'commercial');
  const localEmbeddingProviders = embeddingProviders.filter(p => p.provider_type === 'local');
  const commercialEmbeddingProviders = embeddingProviders.filter(p => p.provider_type === 'commercial');
  
  // æŒ‰è¿è¡Œæ–¹å¼åˆ†ç»„
  const localModeOptions = [
    { id: 'docker', name: 'Docker', description: 'å®¹å™¨æ–¹å¼éƒ¨ç½²' },
    { id: 'ollama', name: 'Ollama', description: 'Ollama æœåŠ¡' },
    { id: 'native', name: 'Python åŸç”Ÿ', description: 'ç›´æ¥è°ƒç”¨æœ¬åœ°æ¨¡å‹' },
  ];
  
  const localProvidersForMode = localProviders.filter(p => (p.local_mode || 'native') === selectedLocalMode);
  const localModelOptions = localProvidersForMode.map(p => ({
    id: p.id,
    name: p.name,
    description: p.description
  }));

  const localEmbeddingProvidersForMode = localEmbeddingProviders.filter(p => (p.local_mode || 'native') === selectedEmbeddingLocalMode);
  const localEmbeddingModelOptions = localEmbeddingProvidersForMode.map(p => ({
    id: p.id,
    name: p.name,
    description: p.description
  }));
  
  // æ ‡ç­¾ç±»åˆ«é…ç½®
  const tagCategories: Array<{ key: keyof MashupConfig; label: string; color: string }> = [
    { key: 'primary_functions', label: 'æ ¸å¿ƒåŠŸèƒ½æ ‡ç­¾', color: 'blue' },
    { key: 'style_effects', label: 'é£æ ¼æ•ˆæœæ ‡ç­¾', color: 'purple' },
    { key: 'connection_types', label: 'è¿æ¥æ–¹å¼', color: 'green' },
    { key: 'editing_rhythms', label: 'å‰ªè¾‘èŠ‚å¥', color: 'orange' },
    { key: 'sound_effects', label: 'éŸ³æ•ˆå»ºè®®', color: 'pink' },
  ];
  
  return (
    <div className="h-full flex bg-[#0d0d0d]">
      {/* å·¦ä¾§å¯¼èˆª */}
      <nav className="w-64 shrink-0 border-r border-white/5 bg-[#0a0a0a] p-4 flex flex-col">
        <div className="mb-6">
          <h1 className="text-xl font-bold text-white flex items-center gap-2">
            <Settings size={22} className="text-blue-400" />
            è®¾ç½®ä¸­å¿ƒ
          </h1>
          <p className="text-xs text-gray-500 mt-1">ç®¡ç† AI æ¨¡å‹å’Œç³»ç»Ÿé…ç½®</p>
        </div>
        
        <div className="space-y-1 flex-1">
          <SettingsNavItem
            icon={<Cpu size={18} />}
            label="è¯­ä¹‰æ ‡å®š"
            active={activeTab === 'llm'}
            onClick={() => setActiveTab('llm')}
          />
          <SettingsNavItem
            icon={<Sparkles size={18} />}
            label="å‘é‡åŒ–æ¨¡å‹"
            active={activeTab === 'embedding'}
            onClick={() => setActiveTab('embedding')}
          />
          <SettingsNavItem
            icon={<Database size={18} />}
            label="å‘é‡æ•°æ®åº“"
            active={activeTab === 'vectordb'}
            onClick={() => setActiveTab('vectordb')}
          />
          <SettingsNavItem
            icon={<FileText size={18} />}
            label="æç¤ºè¯ä¸æ ‡ç­¾"
            active={activeTab === 'prompt'}
            onClick={() => setActiveTab('prompt')}
          />
          
          <div className="!mt-4 pt-4 border-t border-white/5">
            <SettingsNavItem
              icon={<Globe size={18} />}
              label="ç³»ç»Ÿè®¾ç½®"
              active={activeTab === 'system'}
              onClick={() => setActiveTab('system')}
            />
          </div>
        </div>
        
        {/* åº•éƒ¨åˆ·æ–°æŒ‰é’® */}
        <button
          onClick={() => loadAllSettings()}
          disabled={isLoading}
          className="flex items-center justify-center gap-2 px-4 py-2.5 bg-white/5 hover:bg-white/10 rounded-xl text-gray-400 hover:text-white transition-colors"
        >
          <RefreshCw size={14} className={isLoading ? 'animate-spin' : ''} />
          <span className="text-sm">åˆ·æ–°é…ç½®</span>
        </button>
      </nav>
      
      {/* å³ä¾§å†…å®¹åŒº */}
      <main className="flex-1 overflow-y-auto custom-scrollbar p-6">
        <div className="max-w-4xl mx-auto space-y-6">
          
          {/* é”™è¯¯æç¤º */}
          {error && (
            <div className="flex items-center gap-3 p-4 bg-red-500/10 border border-red-500/20 rounded-xl">
              <AlertTriangle size={18} className="text-red-400 shrink-0" />
              <p className="text-sm text-red-400 flex-1">{error}</p>
              <button onClick={() => setError(null)} className="text-red-400 hover:text-red-300">
                <X size={16} />
              </button>
            </div>
          )}
          
          {/* ========== è¯­ä¹‰æ ‡å®šï¼ˆåˆå¹¶æ¨¡å‹é€‰æ‹©å’Œæ ‡æ³¨å‚æ•°ï¼‰========== */}
          {activeTab === 'llm' && (
            <>
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold text-white">è¯­ä¹‰æ ‡å®š</h2>
                  <p className="text-sm text-gray-500 mt-1">é€‰æ‹© AI æ¨¡å‹å¹¶é…ç½®æ ‡æ³¨å‚æ•°</p>
                </div>
                <button
                  onClick={() => handleOpenAddProvider('llm')}
                  className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-xl text-white text-sm transition-colors"
                >
                  <Plus size={14} />
                  æ·»åŠ æ¨¡å‹
                </button>
                <button
                  onClick={() => openConfigEditor('llm')}
                  className="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 rounded-xl text-gray-300 hover:text-white transition-colors"
                >
                  <Edit3 size={14} />
                  ç¼–è¾‘é…ç½®æ–‡ä»¶
                </button>
              </div>
              
              {/* æ¨¡å‹é€‰æ‹©åŒºåŸŸ - ç»Ÿä¸€ä¸‰çº§ä¸‹æ‹‰èœå• */}
              <SettingsSection
                title="æ¨¡å‹é€‰æ‹©"
                icon={<Cpu size={18} />}
                description="é€‰æ‹©ç”¨äºè¯­ä¹‰æ ‡å®šçš„å¤§è¯­è¨€æ¨¡å‹"
                allowOverflow
              >
                <div className="space-y-4">
                  {/* ä¸‰çº§ä¸‹æ‹‰èœå• */}
                  <div className="grid grid-cols-3 gap-4">
                    {/* ç¬¬ä¸€çº§ï¼šç±»å‹ï¼ˆæœ¬åœ°/å•†ç”¨ï¼‰ */}
                    <SelectDropdown
                      label="æ¨¡å‹ç±»å‹"
                      value={selectedProviderType}
                      options={[
                        { id: 'local', name: 'ğŸ–¥ï¸ æœ¬åœ°æ¨¡å‹', description: 'å…è´¹ï¼Œéœ€å¯åŠ¨æœåŠ¡' },
                        { id: 'commercial', name: 'â˜ï¸ å•†ç”¨ API', description: 'ä»˜è´¹ï¼Œç¨³å®šå¯é ' },
                        { id: 'cloud', name: 'â˜ï¸ äº‘ç«¯', description: 'ä¸å•†ç”¨ä¸€è‡´çš„è°ƒç”¨æ–¹å¼' },
                      ]}
                      onChange={(v) => {
                        const nextType = v === 'cloud' ? 'cloud' : v === 'commercial' ? 'commercial' : 'local';
                        setSelectedProviderType(nextType);
                        // åˆ‡æ¢ç±»å‹æ—¶é‡ç½®è¿æ¥çŠ¶æ€
                        useSettingsStore.setState({ llmConnectionStatus: { status: 'idle' } });
                        if (nextType === 'local') {
                          setSelectedCommercialModel('');
                          if (!selectedLocalMode) {
                            setSelectedLocalMode('ollama');
                          }
                        } else {
                          setSelectedLocalModel('');
                        }
                      }}
                      disabled={llmConnectionStatus.status === 'testing'}
                    />
                    
                    {/* ç¬¬äºŒçº§ï¼šè¿è¡Œæ–¹å¼ï¼ˆæœ¬åœ°ï¼‰æˆ– API æä¾›å•†ï¼ˆå•†ç”¨ï¼‰ */}
                    {selectedProviderType === 'local' ? (
                      <SelectDropdown
                        label="è¿è¡Œæ–¹å¼"
                        value={selectedLocalMode}
                        options={localModeOptions}
                        onChange={(v) => {
                          setSelectedLocalMode(v);
                          setSelectedLocalModel('');
                          // åˆ‡æ¢è¿è¡Œæ–¹å¼æ—¶é‡ç½®è¿æ¥çŠ¶æ€
                          useSettingsStore.setState({ llmConnectionStatus: { status: 'idle' } });
                        }}
                        disabled={llmConnectionStatus.status === 'testing'}
                      />
                    ) : (
                      <div className="opacity-50">
                        <label className="text-xs text-gray-500 mb-1.5 block">API æä¾›å•†</label>
                        <div className="px-3 py-2.5 bg-[#1a1a1a] border border-white/10 rounded-lg text-sm text-gray-400">
                          ç”±æ¨¡å‹å†³å®š
                        </div>
                      </div>
                    )}
                    
                    {/* ç¬¬ä¸‰çº§ï¼šå…·ä½“æ¨¡å‹ */}
                    {selectedProviderType === 'local' ? (
                      <SelectDropdown
                        label="é€‰æ‹©æ¨¡å‹"
                        value={selectedLocalModel}
                        options={localModelOptions}
                        onChange={(v) => {
                          setSelectedLocalModel(v);
                          handleSelectProvider(v);
                        }}
                        placeholder={localModelOptions.length === 0 ? 'è¯¥æ–¹å¼æš‚æ— æ¨¡å‹' : 'è¯·é€‰æ‹©æ¨¡å‹'}
                        disabled={localModelOptions.length === 0 || llmConnectionStatus.status === 'testing'}
                      />
                    ) : (
                      <SelectDropdown
                        label="é€‰æ‹©æ¨¡å‹"
                        value={selectedCommercialModel}
                        options={commercialProviders.map(p => ({
                          id: p.id,
                          name: p.name,
                          description: `${p.description}${p.price_info ? ` (${p.price_info})` : ''}`
                        }))}
                        onChange={(v) => {
                          setSelectedCommercialModel(v);
                          if (v) handleSelectProvider(v);
                        }}
                        placeholder="è¯·é€‰æ‹©å•†ç”¨æ¨¡å‹"
                        disabled={llmConnectionStatus.status === 'testing'}
                      />
                    )}
                  </div>
                  
                  {/* å½“å‰é€‰æ‹©çŠ¶æ€å’Œè¿æ¥æµ‹è¯• */}
                  <div className="p-4 bg-[#1a1a1a] rounded-xl border border-white/5">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        {/* å½“å‰æ¨¡å‹ä¿¡æ¯ */}
                        {(() => {
                          const currentProviderId = selectedProviderType === 'local' ? selectedLocalModel : selectedCommercialModel;
                          return currentProviderId ? (
                          <>
                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
                              selectedProviderType === 'local' ? 'bg-green-500/20' : 'bg-purple-500/20'
                            }`}>
                              {selectedProviderType === 'local' ? <Server size={20} className="text-green-400" /> : <Zap size={20} className="text-purple-400" />}
                            </div>
                            <div>
                              <p className="text-sm font-medium text-white">
                                {llmProviders.find(p => p.id === currentProviderId)?.name || 'æœªçŸ¥æ¨¡å‹'}
                              </p>
                              <p className="text-xs text-gray-500">
                                {selectedProviderType === 'local' ? `æœ¬åœ° Â· ${selectedLocalMode}` : (selectedProviderType === 'cloud' ? 'äº‘ç«¯ API' : 'å•†ç”¨ API')}
                                {selectedProviderType === 'local' && (
                                  <span className="text-green-400 ml-2">å…è´¹</span>
                                )}
                                {selectedProviderType === 'commercial' && (
                                  <span className="text-purple-400 ml-2">
                                    {llmProviders.find(p => p.id === currentProviderId)?.price_info || ''}
                                  </span>
                                )}
                              </p>
                            </div>
                          </>
                        ) : (
                          <div className="flex items-center gap-2 text-gray-500">
                            <AlertTriangle size={16} />
                            <span className="text-sm">è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹</span>
                          </div>
                        );
                        })()}
                      </div>
                      
                      {/* è¿æ¥çŠ¶æ€å’Œæµ‹è¯•æŒ‰é’® */}
                      <div className="flex items-center gap-3">
                        <div className="flex items-center gap-2">
                          {llmConnectionStatus.status === 'connected' && (
                            <><CheckCircle2 size={14} className="text-green-400" /><span className="text-xs text-green-400">å·²è¿æ¥</span></>
                          )}
                          {llmConnectionStatus.status === 'failed' && (
                            <><XCircle size={14} className="text-red-400" /><span className="text-xs text-red-400">{llmConnectionStatus.error || 'è¿æ¥å¤±è´¥'}</span></>
                          )}
                          {llmConnectionStatus.status === 'testing' && (
                            <><Loader2 size={14} className="text-blue-400 animate-spin" /><span className="text-xs text-blue-400">æµ‹è¯•ä¸­...</span></>
                          )}
                        </div>
                        <button
                          onClick={() => {
                            const providerId = selectedProviderType === 'local' ? selectedLocalModel : selectedCommercialModel;
                            if (providerId) testLLMConnection(providerId);
                          }}
                          disabled={(!(selectedProviderType === 'local' ? selectedLocalModel : selectedCommercialModel) || llmConnectionStatus.status === 'testing')}
                          className={`flex items-center gap-1 px-4 py-2 rounded-lg text-white text-xs transition-colors ${
                            selectedProviderType === 'local' 
                              ? 'bg-green-600 hover:bg-green-500' 
                              : 'bg-purple-600 hover:bg-purple-500'
                          } disabled:bg-gray-700 disabled:cursor-not-allowed`}
                        >
                          {llmConnectionStatus.status === 'testing' ? (
                            <Loader2 size={12} className="animate-spin" />
                          ) : (
                            <TestTube size={12} />
                          )}
                          æµ‹è¯•è¿æ¥
                        </button>
                      </div>
                    </div>
                    
                    {/* æœ¬åœ°æ¨¡å‹æç¤º */}
                    {selectedLocalModel && (
                      <div className="mt-3 p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
                        <div className="flex items-start gap-2">
                          <Info size={14} className="text-yellow-400 mt-0.5 shrink-0" />
                          <div className="text-xs text-yellow-300/80">
                            <p className="font-medium text-yellow-400 mb-1">ä½¿ç”¨æœ¬åœ°æ¨¡å‹å‰è¯·ç¡®ä¿ï¼š</p>
                            <ul className="list-disc list-inside space-y-0.5">
                              {selectedLocalMode === 'docker' && <li>Docker å®¹å™¨å·²å¯åŠ¨å¹¶è¿è¡Œ</li>}
                              {selectedLocalMode === 'ollama' && <li>Ollama æœåŠ¡å·²å¯åŠ¨ (ollama serve)</li>}
                              {selectedLocalMode === 'native' && <li>Python ç¯å¢ƒå’Œæ¨¡å‹å·²æ­£ç¡®é…ç½®</li>}
                              <li>æ¨¡å‹æœåŠ¡åœ°å€å¯è®¿é—®</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </SettingsSection>
              
              {/* å·²é…ç½®æ¨¡å‹åˆ—è¡¨ */}
              <SettingsSection
                title="å·²é…ç½®æ¨¡å‹"
                icon={<Server size={18} />}
                description="ç®¡ç†æ‰€æœ‰ LLM æ¨¡å‹é…ç½®"
                action={
                  <button onClick={handleResetDefaults} className="text-xs text-gray-500 hover:text-red-400 transition-colors">
                    é‡ç½®é»˜è®¤
                  </button>
                }
              >
                <div className="space-y-2">
                  {llmProviders.map(p => (
                    <div key={p.id} className={`flex items-center justify-between p-3 rounded-lg border transition-colors ${
                      p.id === activeLLMProvider 
                        ? 'bg-blue-500/10 border-blue-500/30' 
                        : 'bg-[#1a1a1a] border-white/5 hover:border-white/10'
                    }`}>
                      <div className="flex items-center gap-3">
                        <div className={`w-2 h-2 rounded-full ${p.enabled ? 'bg-green-400' : 'bg-gray-600'}`} />
                        <div>
                          <span className="text-sm text-white">{p.name}</span>
                          <span className="text-xs text-gray-500 ml-2">
                            {p.provider_type === 'local' ? `æœ¬åœ°Â·${p.local_mode}` : 'å•†ç”¨'}
                            {p.price_info && ` Â· ${p.price_info}`}
                          </span>
                        </div>
                        {p.id === activeLLMProvider && (
                          <span className="text-[10px] px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-400">å½“å‰</span>
                        )}
                      </div>
                      <div className="flex items-center gap-1">
                        <button onClick={() => handleOpenEditProvider(p)} className="p-1.5 hover:bg-white/10 rounded text-gray-400 hover:text-white transition-colors" title="ç¼–è¾‘">
                          <Edit3 size={12} />
                        </button>
                        {!p.is_default && (
                          <button onClick={() => handleDeleteProvider(p.id, p.name)} className="p-1.5 hover:bg-red-500/20 rounded text-gray-400 hover:text-red-400 transition-colors" title="åˆ é™¤">
                            <X size={12} />
                          </button>
                        )}
                      </div>
                    </div>
                  ))}
                  {llmProviders.length === 0 && (
                    <p className="text-center text-sm text-gray-500 py-4">æš‚æ— æ¨¡å‹é…ç½®</p>
                  )}
                </div>
              </SettingsSection>
              
              {/* æ ‡æ³¨å‚æ•° */}
              <SettingsSection
                title="æ ‡æ³¨å‚æ•°"
                icon={<Sliders size={18} />}
                description="è°ƒæ•´è¯­ä¹‰æ ‡æ³¨çš„è¿è¡Œå‚æ•°"
                action={
                  <button
                    onClick={handleSaveAnnotationConfig}
                    disabled={!annotationHasChanges || isSaving || !annotationConfig._loaded}
                    className={`flex items-center gap-2 px-3 py-1.5 text-xs rounded-lg transition-colors ${
                      annotationHasChanges && !isSaving && annotationConfig._loaded
                        ? 'bg-blue-500/20 text-blue-300 hover:bg-blue-500/30'
                        : 'bg-white/5 text-gray-500 cursor-not-allowed'
                    }`}
                  >
                    <Save size={12} />
                    ä¿å­˜
                  </button>
                }
              >
                {!annotationConfig._loaded ? (
                  <div className="flex items-center justify-center py-8 text-gray-500">
                    <Loader2 size={20} className="animate-spin mr-2" />
                    <span className="text-sm">åŠ è½½é…ç½®ä¸­...</span>
                  </div>
                ) : (
                <>
                <div className="grid grid-cols-2 gap-6">
                  <div className="space-y-2">
                    <label className="flex items-center justify-between">
                      <span className="text-sm text-gray-300">æ‰¹å¤„ç†å¤§å°</span>
                      <span className="text-xs text-blue-400 bg-blue-500/20 px-2 py-0.5 rounded">
                        {annotationDraft?.batch_size ?? annotationConfig.batch_size}
                      </span>
                    </label>
                    <input
                      type="range"
                      min="1"
                      max="50"
                      value={annotationDraft?.batch_size ?? annotationConfig.batch_size}
                      onChange={(e) => handleAnnotationDraftChange({ batch_size: parseInt(e.target.value) })}
                      className="w-full accent-blue-500"
                    />
                    <p className="text-xs text-gray-500">æ¯æ¬¡è¯·æ±‚å¤„ç†çš„å­—å¹•æ•°é‡</p>
                  </div>
                  
                  <div className="space-y-2">
                    <label className="flex items-center justify-between">
                      <span className="text-sm text-gray-300">å¹¶å‘è¯·æ±‚æ•°</span>
                      <span className="text-xs text-blue-400 bg-blue-500/20 px-2 py-0.5 rounded">
                        {annotationDraft?.concurrent_requests ?? annotationConfig.concurrent_requests}
                      </span>
                    </label>
                    <input
                      type="range"
                      min="1"
                      max="5"
                      value={annotationDraft?.concurrent_requests ?? annotationConfig.concurrent_requests}
                      onChange={(e) => handleAnnotationDraftChange({ concurrent_requests: parseInt(e.target.value) })}
                      className="w-full accent-blue-500"
                    />
                    <p className="text-xs text-gray-500">åŒæ—¶å‘é€çš„ API è¯·æ±‚æ•°é‡</p>
                  </div>
                  
                  <div className="space-y-2">
                    <label className="flex items-center justify-between">
                      <span className="text-sm text-gray-300">æœ€å¤§é‡è¯•æ¬¡æ•°</span>
                      <span className="text-xs text-purple-400 bg-purple-500/20 px-2 py-0.5 rounded">
                        {annotationDraft?.max_retries ?? annotationConfig.max_retries}
                      </span>
                    </label>
                    <input
                      type="range"
                      min="0"
                      max="5"
                      value={annotationDraft?.max_retries ?? annotationConfig.max_retries}
                      onChange={(e) => handleAnnotationDraftChange({ max_retries: parseInt(e.target.value) })}
                      className="w-full accent-purple-500"
                    />
                    <p className="text-xs text-gray-500">è¯·æ±‚å¤±è´¥æ—¶çš„é‡è¯•æ¬¡æ•°</p>
                  </div>
                  
                  <div className="space-y-2">
                    <label className="flex items-center justify-between">
                      <span className="text-sm text-gray-300">è‡ªåŠ¨ä¿å­˜é—´éš”</span>
                      <span className="text-xs text-green-400 bg-green-500/20 px-2 py-0.5 rounded">
                        {(annotationDraft?.save_interval ?? annotationConfig.save_interval)} æ¡
                      </span>
                    </label>
                    <input
                      type="range"
                      min="1"
                      max="20"
                      value={annotationDraft?.save_interval ?? annotationConfig.save_interval}
                      onChange={(e) => handleAnnotationDraftChange({ save_interval: parseInt(e.target.value) })}
                      className="w-full accent-green-500"
                    />
                    <p className="text-xs text-gray-500">æ¯å¤„ç†å¤šå°‘æ¡åä¿å­˜ä¸€æ¬¡</p>
                  </div>
                </div>
                
                <div className="mt-4 pt-4 border-t border-white/5">
                  <div className="grid grid-cols-2 gap-6">
                    <div className="space-y-2">
                      <label className="text-sm text-gray-300">é‡è¯•å»¶è¿Ÿ (æ¯«ç§’)</label>
                      <input
                        type="number"
                        min="100"
                        max="10000"
                        step="100"
                        value={annotationDraft?.retry_delay ?? annotationConfig.retry_delay}
                        onChange={(e) => handleAnnotationDraftChange({ retry_delay: parseInt(e.target.value) })}
                        className="w-full px-3 py-2 bg-[#1a1a1a] border border-white/10 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500"
                      />
                    </div>
                  </div>
                </div>
                <div className="mt-4 flex items-center justify-between text-xs text-gray-500">
                  <span>ä¿®æ”¹åç‚¹å‡»ä¿å­˜ä»¥ç”Ÿæ•ˆ</span>
                  {annotationHasChanges && <span className="text-blue-400">æœ‰æœªä¿å­˜çš„æ›´æ”¹</span>}
                </div>
                </>
                )}
              </SettingsSection>
            </>
          )}
          
          {/* ========== å‘é‡åŒ–æ¨¡å‹ ========== */}
          {activeTab === 'embedding' && (
            <>
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold text-white">å‘é‡åŒ–æ¨¡å‹</h2>
                  <p className="text-sm text-gray-500 mt-1">é€‰æ‹©ç”¨äºç”Ÿæˆæ–‡æœ¬å‘é‡çš„ Embedding æ¨¡å‹</p>
                </div>
                <button
                  onClick={() => handleOpenAddProvider('embedding')}
                  className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-xl text-white text-sm transition-colors"
                >
                  <Plus size={14} />
                  æ·»åŠ æ¨¡å‹
                </button>
                <button
                  onClick={() => openConfigEditor('embedding')}
                  className="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 rounded-xl text-gray-300 hover:text-white transition-colors"
                >
                  <Edit3 size={14} />
                  ç¼–è¾‘é…ç½®æ–‡ä»¶
                </button>
              </div>
              
              {/* æ¨¡å‹é€‰æ‹©åŒºåŸŸ - ç»Ÿä¸€ä¸‰çº§ä¸‹æ‹‰èœå• */}
              <SettingsSection
                title="æ¨¡å‹é€‰æ‹©"
                icon={<Sparkles size={18} />}
                description="é€‰æ‹©ç”¨äºå‘é‡åŒ–çš„ Embedding æ¨¡å‹"
                allowOverflow
              >
                <div className="space-y-4">
                  {/* ä¸‰çº§ä¸‹æ‹‰èœå• */}
                  <div className="grid grid-cols-3 gap-4">
                    {/* ç¬¬ä¸€çº§ï¼šç±»å‹ï¼ˆæœ¬åœ°/å•†ç”¨ï¼‰ */}
                    <SelectDropdown
                      label="æ¨¡å‹ç±»å‹"
                      value={selectedEmbeddingProviderType}
                      options={[
                        { id: 'local', name: 'ğŸ–¥ï¸ æœ¬åœ°æ¨¡å‹', description: 'å…è´¹ï¼Œéœ€å¯åŠ¨æœåŠ¡' },
                        { id: 'commercial', name: 'â˜ï¸ å•†ç”¨ API', description: 'ä»˜è´¹ï¼Œç¨³å®šå¯é ' },
                        { id: 'cloud', name: 'â˜ï¸ äº‘ç«¯', description: 'ä¸å•†ç”¨ä¸€è‡´çš„è°ƒç”¨æ–¹å¼' },
                      ]}
                      onChange={(v) => {
                        const nextType = v === 'cloud' ? 'cloud' : v === 'commercial' ? 'commercial' : 'local';
                        setSelectedEmbeddingProviderType(nextType);
                        // åˆ‡æ¢ç±»å‹æ—¶é‡ç½®è¿æ¥çŠ¶æ€
                        setEmbeddingConnectionStatus({ status: 'idle' });
                        if (nextType === 'local') {
                          setSelectedEmbeddingCommercialModel('');
                          if (!selectedEmbeddingLocalMode) {
                            setSelectedEmbeddingLocalMode('ollama');
                          }
                        } else {
                          setSelectedEmbeddingLocalModel('');
                        }
                      }}
                      disabled={embeddingConnectionStatus.status === 'testing'}
                    />
                    
                    {/* ç¬¬äºŒçº§ï¼šè¿è¡Œæ–¹å¼ï¼ˆæœ¬åœ°ï¼‰æˆ– API æä¾›å•†ï¼ˆå•†ç”¨ï¼‰ */}
                    {selectedEmbeddingProviderType === 'local' ? (
                      <SelectDropdown
                        label="è¿è¡Œæ–¹å¼"
                        value={selectedEmbeddingLocalMode}
                        options={localModeOptions}
                        onChange={(v) => {
                          setSelectedEmbeddingLocalMode(v);
                          setSelectedEmbeddingLocalModel('');
                          // åˆ‡æ¢è¿è¡Œæ–¹å¼æ—¶é‡ç½®è¿æ¥çŠ¶æ€
                          setEmbeddingConnectionStatus({ status: 'idle' });
                        }}
                        disabled={embeddingConnectionStatus.status === 'testing'}
                      />
                    ) : (
                      <div className="opacity-50">
                        <label className="text-xs text-gray-500 mb-1.5 block">API æä¾›å•†</label>
                        <div className="px-3 py-2.5 bg-[#1a1a1a] border border-white/10 rounded-lg text-sm text-gray-400">
                          ç”±æ¨¡å‹å†³å®š
                        </div>
                      </div>
                    )}
                    
                    {/* ç¬¬ä¸‰çº§ï¼šå…·ä½“æ¨¡å‹ */}
                    {selectedEmbeddingProviderType === 'local' ? (
                      <SelectDropdown
                        label="é€‰æ‹©æ¨¡å‹"
                        value={selectedEmbeddingLocalModel}
                        options={localEmbeddingModelOptions}
                        onChange={(v) => {
                          setSelectedEmbeddingLocalModel(v);
                          handleSelectEmbeddingProvider(v);
                        }}
                        placeholder={localEmbeddingModelOptions.length === 0 ? 'è¯¥æ–¹å¼æš‚æ— æ¨¡å‹' : 'è¯·é€‰æ‹©æ¨¡å‹'}
                        disabled={localEmbeddingModelOptions.length === 0 || embeddingConnectionStatus.status === 'testing'}
                      />
                    ) : (
                      <SelectDropdown
                        label="é€‰æ‹©æ¨¡å‹"
                        value={selectedEmbeddingCommercialModel}
                        options={commercialEmbeddingProviders.map(p => ({
                          id: p.id,
                          name: p.name,
                          description: `${p.description}${p.dimension ? ` (ç»´åº¦: ${p.dimension})` : ''}${p.price_info ? ` ${p.price_info}` : ''}`
                        }))}
                        onChange={(v) => {
                          setSelectedEmbeddingCommercialModel(v);
                          if (v) handleSelectEmbeddingProvider(v);
                        }}
                        placeholder="è¯·é€‰æ‹©å•†ç”¨æ¨¡å‹"
                        disabled={embeddingConnectionStatus.status === 'testing'}
                      />
                    )}
                  </div>
                  
                  {/* å½“å‰é€‰æ‹©çŠ¶æ€å’Œè¿æ¥æµ‹è¯• */}
                  <div className="p-4 bg-[#1a1a1a] rounded-xl border border-white/5">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        {/* å½“å‰æ¨¡å‹ä¿¡æ¯ */}
                        {(() => {
                          const currentProviderId = selectedEmbeddingProviderType === 'local' ? selectedEmbeddingLocalModel : selectedEmbeddingCommercialModel;
                          const currentProvider = embeddingProviders.find(p => p.id === currentProviderId);
                          return currentProviderId ? (
                          <>
                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
                              selectedEmbeddingProviderType === 'local' ? 'bg-green-500/20' : 'bg-purple-500/20'
                            }`}>
                              {selectedEmbeddingProviderType === 'local' ? <Server size={20} className="text-green-400" /> : <Zap size={20} className="text-purple-400" />}
                            </div>
                            <div>
                              <p className="text-sm font-medium text-white">
                                {currentProvider?.name || 'æœªçŸ¥æ¨¡å‹'}
                                {currentProvider?.dimension && (
                                  <span className="ml-2 text-xs text-purple-400">ç»´åº¦: {currentProvider.dimension}</span>
                                )}
                              </p>
                              <p className="text-xs text-gray-500">
                                {selectedEmbeddingProviderType === 'local' ? `æœ¬åœ° Â· ${selectedEmbeddingLocalMode}` : (selectedEmbeddingProviderType === 'cloud' ? 'äº‘ç«¯ API' : 'å•†ç”¨ API')}
                                {selectedEmbeddingProviderType === 'local' && (
                                  <span className="text-green-400 ml-2">å…è´¹</span>
                                )}
                                {selectedEmbeddingProviderType !== 'local' && (
                                  <span className="text-purple-400 ml-2">
                                    {currentProvider?.price_info || ''}
                                  </span>
                                )}
                              </p>
                            </div>
                          </>
                        ) : (
                          <div className="flex items-center gap-2 text-gray-500">
                            <AlertTriangle size={16} />
                            <span className="text-sm">è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹</span>
                          </div>
                        );
                        })()}
                      </div>
                      
                      {/* è¿æ¥çŠ¶æ€å’Œæµ‹è¯•æŒ‰é’® */}
                      <div className="flex items-center gap-3">
                        <div className="flex items-center gap-2">
                          {embeddingConnectionStatus.status === 'connected' && (
                            <><CheckCircle2 size={14} className="text-green-400" /><span className="text-xs text-green-400">å·²è¿æ¥</span></>
                          )}
                          {embeddingConnectionStatus.status === 'failed' && (
                            <><XCircle size={14} className="text-red-400" /><span className="text-xs text-red-400">{embeddingConnectionStatus.error || 'è¿æ¥å¤±è´¥'}</span></>
                          )}
                          {embeddingConnectionStatus.status === 'testing' && (
                            <><Loader2 size={14} className="text-blue-400 animate-spin" /><span className="text-xs text-blue-400">æµ‹è¯•ä¸­...</span></>
                          )}
                        </div>
                        <button
                          onClick={() => {
                            const providerId = selectedEmbeddingProviderType === 'local' ? selectedEmbeddingLocalModel : selectedEmbeddingCommercialModel;
                            if (providerId) testEmbeddingConnection();
                          }}
                          disabled={(!(selectedEmbeddingProviderType === 'local' ? selectedEmbeddingLocalModel : selectedEmbeddingCommercialModel) || embeddingConnectionStatus.status === 'testing')}
                          className={`flex items-center gap-1 px-4 py-2 rounded-lg text-white text-xs transition-colors ${
                            selectedEmbeddingProviderType === 'local' 
                              ? 'bg-green-600 hover:bg-green-500' 
                              : 'bg-purple-600 hover:bg-purple-500'
                          } disabled:bg-gray-700 disabled:cursor-not-allowed`}
                        >
                          {embeddingConnectionStatus.status === 'testing' ? (
                            <Loader2 size={12} className="animate-spin" />
                          ) : (
                            <TestTube size={12} />
                          )}
                          æµ‹è¯•è¿æ¥
                        </button>
                      </div>
                    </div>
                    
                    {/* æœ¬åœ°æ¨¡å‹æç¤º */}
                    {selectedEmbeddingLocalModel && selectedEmbeddingProviderType === 'local' && (
                      <div className="mt-3 p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
                        <div className="flex items-start gap-2">
                          <Info size={14} className="text-yellow-400 mt-0.5 shrink-0" />
                          <div className="text-xs text-yellow-300/80">
                            <p className="font-medium text-yellow-400 mb-1">ä½¿ç”¨æœ¬åœ°å‘é‡æ¨¡å‹å‰è¯·ç¡®ä¿ï¼š</p>
                            <ul className="list-disc list-inside space-y-0.5">
                              {selectedEmbeddingLocalMode === 'docker' && <li>Docker å®¹å™¨å·²å¯åŠ¨å¹¶è¿è¡Œ</li>}
                              {selectedEmbeddingLocalMode === 'ollama' && <li>Ollama æœåŠ¡å·²å¯åŠ¨ (ollama serve)</li>}
                              {selectedEmbeddingLocalMode === 'native' && <li>Python ç¯å¢ƒå’Œæ¨¡å‹å·²æ­£ç¡®é…ç½®</li>}
                              <li>å‘é‡åŒ–æœåŠ¡åœ°å€å¯è®¿é—®</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </SettingsSection>
              
              {/* å‘é‡åŒ–å‚æ•° */}
              <SettingsSection
                title="å‘é‡åŒ–å‚æ•°"
                icon={<Sliders size={18} />}
                description="è°ƒæ•´å‘é‡åŒ–å¤„ç†çš„è¿è¡Œå‚æ•°"
                action={
                  <button
                    onClick={handleSaveVectorizationConfig}
                    disabled={!vectorizationHasChanges || isSaving || !vectorizationConfig._loaded}
                    className={`flex items-center gap-2 px-3 py-1.5 text-xs rounded-lg transition-colors ${
                      vectorizationHasChanges && !isSaving && vectorizationConfig._loaded
                        ? 'bg-blue-500/20 text-blue-300 hover:bg-blue-500/30'
                        : 'bg-white/5 text-gray-500 cursor-not-allowed'
                    }`}
                  >
                    <Save size={12} />
                    ä¿å­˜
                  </button>
                }
              >
                {!vectorizationConfig._loaded ? (
                  <div className="flex items-center justify-center py-8 text-gray-500">
                    <Loader2 size={20} className="animate-spin mr-2" />
                    <span className="text-sm">åŠ è½½é…ç½®ä¸­...</span>
                  </div>
                ) : (
                <>
                <div className="grid grid-cols-2 gap-6">
                  <div className="space-y-2">
                    <label className="flex items-center justify-between">
                      <span className="text-sm text-gray-300">æ‰¹å¤„ç†å¤§å°</span>
                      <span className="text-xs text-blue-400 bg-blue-500/20 px-2 py-0.5 rounded">
                        {vectorizationDraft?.batch_size ?? vectorizationConfig.batch_size}
                      </span>
                    </label>
                    <input
                      type="range"
                      min="10"
                      max="200"
                      step="10"
                      value={vectorizationDraft?.batch_size ?? vectorizationConfig.batch_size}
                      onChange={(e) => handleVectorizationDraftChange({ batch_size: parseInt(e.target.value) })}
                      className="w-full accent-blue-500"
                    />
                    <p className="text-xs text-gray-500">æ¯æ¬¡è¯·æ±‚å¤„ç†çš„æ–‡æœ¬æ•°é‡ï¼ˆå‘é‡åŒ–æ•°æ®é‡å¤§ï¼Œå»ºè®®è¾ƒé«˜å€¼ï¼‰</p>
                  </div>
                  
                  <div className="space-y-2">
                    <label className="flex items-center justify-between">
                      <span className="text-sm text-gray-300">å¹¶å‘è¯·æ±‚æ•°</span>
                      <span className="text-xs text-blue-400 bg-blue-500/20 px-2 py-0.5 rounded">
                        {vectorizationDraft?.concurrent_requests ?? vectorizationConfig.concurrent_requests}
                      </span>
                    </label>
                    <input
                      type="range"
                      min="1"
                      max="8"
                      value={vectorizationDraft?.concurrent_requests ?? vectorizationConfig.concurrent_requests}
                      onChange={(e) => handleVectorizationDraftChange({ concurrent_requests: parseInt(e.target.value) })}
                      className="w-full accent-blue-500"
                    />
                    <p className="text-xs text-gray-500">åŒæ—¶å‘é€çš„å‘é‡åŒ–è¯·æ±‚æ•°é‡</p>
                  </div>
                  
                  <div className="space-y-2">
                    <label className="flex items-center justify-between">
                      <span className="text-sm text-gray-300">æœ€å¤§é‡è¯•æ¬¡æ•°</span>
                      <span className="text-xs text-purple-400 bg-purple-500/20 px-2 py-0.5 rounded">
                        {vectorizationDraft?.max_retries ?? vectorizationConfig.max_retries}
                      </span>
                    </label>
                    <input
                      type="range"
                      min="0"
                      max="5"
                      value={vectorizationDraft?.max_retries ?? vectorizationConfig.max_retries}
                      onChange={(e) => handleVectorizationDraftChange({ max_retries: parseInt(e.target.value) })}
                      className="w-full accent-purple-500"
                    />
                    <p className="text-xs text-gray-500">è¯·æ±‚å¤±è´¥æ—¶çš„é‡è¯•æ¬¡æ•°</p>
                  </div>
                  
                  <div className="space-y-2">
                    <label className="text-sm text-gray-300">é‡è¯•å»¶è¿Ÿ (æ¯«ç§’)</label>
                    <input
                      type="number"
                      min="100"
                      max="5000"
                      step="100"
                      value={vectorizationDraft?.retry_delay ?? vectorizationConfig.retry_delay}
                      onChange={(e) => handleVectorizationDraftChange({ retry_delay: parseInt(e.target.value) })}
                      className="w-full px-3 py-2 bg-[#1a1a1a] border border-white/10 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500"
                    />
                  </div>
                </div>
                <div className="mt-4 flex items-center justify-between text-xs text-gray-500">
                  <span>ä¿®æ”¹åç‚¹å‡»ä¿å­˜ä»¥ç”Ÿæ•ˆ</span>
                  {vectorizationHasChanges && <span className="text-blue-400">æœ‰æœªä¿å­˜çš„æ›´æ”¹</span>}
                </div>
                </>
                )}
              </SettingsSection>
              
              {/* é‡è¦æç¤º */}
              <div className="p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl">
                <div className="flex items-start gap-3">
                  <AlertTriangle size={18} className="text-yellow-400 shrink-0 mt-0.5" />
                  <div>
                    <p className="text-sm font-medium text-yellow-400">é‡è¦æç¤º</p>
                    <p className="text-xs text-yellow-300/80 mt-1">
                      å‘é‡åŒ–æ¨¡å‹ä¸å‘é‡æ•°æ®åº“çš„ç´¢å¼•å¼•æ“å¿…é¡»ä¿æŒä¸€è‡´ï¼æ›´æ¢æ¨¡å‹åéœ€è¦é‡æ–°å‘é‡åŒ–æ‰€æœ‰å·²æ ‡æ³¨å†…å®¹ï¼Œå¦åˆ™æœç´¢å°†æ— æ³•æ­£å¸¸å·¥ä½œã€‚
                    </p>
                  </div>
                </div>
              </div>
              
              <div className="p-4 bg-blue-500/5 border border-blue-500/10 rounded-xl">
                <div className="flex items-start gap-3">
                  <Info size={16} className="text-blue-400 shrink-0 mt-0.5" />
                  <div className="text-xs text-gray-400 space-y-2">
                    <p><strong className="text-gray-300">æ¨¡å‹ç®¡ç†ï¼š</strong>æ‰€æœ‰æ¨¡å‹é…ç½®å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œå¯é€šè¿‡ä¸Šæ–¹ã€Œæ·»åŠ æ¨¡å‹ã€æŒ‰é’®æ–°å¢</p>
                    <p><strong className="text-gray-300">æ³¨æ„ï¼š</strong>æ›´æ”¹å‘é‡ç»´åº¦åï¼Œéœ€è¦é‡æ–°å‘é‡åŒ–æ‰€æœ‰å·²æ ‡æ³¨çš„å†…å®¹</p>
                  </div>
                </div>
              </div>
            </>
          )}
          
          {/* ========== å‘é‡æ•°æ®åº“ ========== */}
          {activeTab === 'vectordb' && (
            <>
              <div>
                <h2 className="text-2xl font-bold text-white">å‘é‡æ•°æ®åº“</h2>
                <p className="text-sm text-gray-500 mt-1">ç®¡ç†å‘é‡å­˜å‚¨å’Œæ£€ç´¢é…ç½®</p>
              </div>
              
              {/* ä¸€è‡´æ€§æç¤º */}
              <div className="p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl">
                <div className="flex items-start gap-3">
                  <AlertTriangle size={18} className="text-yellow-400 shrink-0 mt-0.5" />
                  <div>
                    <p className="text-sm font-medium text-yellow-400">å¼•æ“ä¸€è‡´æ€§</p>
                    <p className="text-xs text-yellow-300/80 mt-1">
                      å‘é‡æ•°æ®åº“çš„ç´¢å¼•å¼•æ“å¿…é¡»ä¸å‘é‡åŒ–æ¨¡å‹åŒ¹é…ã€‚å½“å‰ä½¿ç”¨ ChromaDB + Qwen3-Embeddingï¼Œè¯·ç¡®ä¿å‘é‡åŒ–æ—¶ä½¿ç”¨ç›¸åŒçš„æ¨¡å‹ã€‚
                    </p>
                  </div>
                </div>
              </div>
              
              <SettingsSection
                title="æ•°æ®åº“é…ç½®"
                icon={<Database size={18} />}
                description="å½“å‰ä½¿ç”¨ ChromaDB ä½œä¸ºå‘é‡æ•°æ®åº“"
              >
                <div className="space-y-4">
                  <div className="flex items-center gap-4 p-4 bg-[#1a1a1a] rounded-xl">
                    <div className="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center">
                      <Database size={24} className="text-green-400" />
                    </div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2">
                        <span className="font-medium text-white">ChromaDB</span>
                        <span className="text-[10px] px-1.5 py-0.5 rounded bg-green-500/20 text-green-400">æœ¬åœ°</span>
                      </div>
                      <p className="text-xs text-gray-400 mt-0.5">å¼€æºå‘é‡æ•°æ®åº“ï¼Œæ”¯æŒæœ¬åœ°æŒä¹…åŒ–å­˜å‚¨</p>
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-2">
                      <label className="text-xs text-gray-500">æ•°æ®å­˜å‚¨è·¯å¾„</label>
                      <div className="flex items-center gap-2">
                        <input
                          type="text"
                          value={vectorDB.path}
                          readOnly
                          className="flex-1 px-3 py-2 bg-[#1a1a1a] border border-white/10 rounded-lg text-sm text-gray-300 focus:outline-none"
                        />
                        <button 
                          onClick={() => handleSelectFolder('vectordb_path')}
                          className="p-2 bg-white/5 hover:bg-white/10 rounded-lg transition-colors"
                        >
                          <FolderOpen size={16} className="text-gray-400" />
                        </button>
                      </div>
                    </div>
                    <div className="space-y-2">
                      <label className="text-xs text-gray-500">é›†åˆåç§°</label>
                      <input
                        type="text"
                        value={vectorDB.collection_name}
                        readOnly
                        className="w-full px-3 py-2 bg-[#1a1a1a] border border-white/10 rounded-lg text-sm text-gray-300 focus:outline-none"
                      />
                    </div>
                  </div>
                </div>
              </SettingsSection>
              
              <SettingsSection
                title="å­˜å‚¨ç»Ÿè®¡"
                icon={<HardDrive size={18} />}
              >
                <div className="grid grid-cols-3 gap-4">
                  <div className="p-4 bg-[#1a1a1a] rounded-xl text-center">
                    <div className="text-3xl font-bold text-blue-400">0</div>
                    <div className="text-xs text-gray-500 mt-1">å‘é‡æ€»æ•°</div>
                  </div>
                  <div className="p-4 bg-[#1a1a1a] rounded-xl text-center">
                    <div className="text-3xl font-bold text-green-400">0 MB</div>
                    <div className="text-xs text-gray-500 mt-1">å­˜å‚¨ç©ºé—´</div>
                  </div>
                  <div className="p-4 bg-[#1a1a1a] rounded-xl text-center">
                    <div className="text-3xl font-bold text-purple-400">0</div>
                    <div className="text-xs text-gray-500 mt-1">å½±ç‰‡æ•°é‡</div>
                  </div>
                </div>
              </SettingsSection>
            </>
          )}
          
          {/* ========== æç¤ºè¯ä¸æ ‡ç­¾é…ç½® ========== */}
          {activeTab === 'prompt' && (
            <>
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold text-white">æç¤ºè¯ä¸æ ‡ç­¾é…ç½®</h2>
                  <p className="text-sm text-gray-500 mt-1">è‡ªå®šä¹‰è¯­ä¹‰æ ‡æ³¨çš„æç¤ºè¯æ¨¡æ¿å’Œæ··å‰ªæ ‡ç­¾ä½“ç³»</p>
                </div>
                <div className="flex items-center gap-2">
                  <button
                    onClick={() => openConfigEditor('prompt')}
                    className="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 rounded-xl text-gray-300 hover:text-white transition-colors"
                  >
                    <Edit3 size={14} />
                    ç¼–è¾‘æç¤ºè¯
                  </button>
                  <button
                    onClick={() => openConfigEditor('mashup')}
                    className="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 rounded-xl text-gray-300 hover:text-white transition-colors"
                  >
                    <Tag size={14} />
                    ç¼–è¾‘æ ‡ç­¾é…ç½®
                  </button>
                </div>
              </div>
              
              {/* æç¤ºè¯æ¨¡æ¿ */}
              <SettingsSection
                title="æç¤ºè¯æ¨¡æ¿"
                icon={<FileText size={18} />}
                description="æ§åˆ¶ AI åˆ†æå°è¯æ—¶çš„è¾“å‡ºæ ¼å¼"
              >
                <div className="space-y-4">
                  {/* ç³»ç»Ÿæç¤ºè¯ */}
                  <div 
                    className="p-4 bg-[#1a1a1a] rounded-xl cursor-pointer hover:bg-[#1f1f1f] transition-colors"
                    onClick={() => setShowPromptPreview(showPromptPreview === 'system' ? null : 'system')}
                  >
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-xs text-gray-500">ç³»ç»Ÿæç¤ºè¯ (System Prompt)</span>
                      <button className="text-[10px] px-2 py-0.5 rounded bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 transition-colors">
                        {showPromptPreview === 'system' ? 'æ”¶èµ·' : 'å±•å¼€é¢„è§ˆ'}
                      </button>
                    </div>
                    <p className={`text-sm text-gray-300 ${showPromptPreview === 'system' ? '' : 'line-clamp-3'}`}>
                      ä½ æ˜¯èµ„æ·±å½±è§†æ··å‰ªUPä¸»ï¼Œæ“…é•¿åˆ¶ä½œè·¨ä½œå“ã€æ— å˜å¤´ã€æç¬‘å‘çš„æ··å‰ªè§†é¢‘ã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ†æå°è¯ç‰‡æ®µï¼Œè¯„ä¼°å…¶åœ¨è„±ç¦»åŸç‰‡è¯­å¢ƒåçš„æ··å‰ªæ½œåŠ›ã€‚

é‡ç‚¹å…³æ³¨ï¼š
1. å°è¯çš„é€šç”¨æ€§ - èƒ½å¦è„±ç¦»åŸè¯­å¢ƒç‹¬ç«‹ä½¿ç”¨
2. æƒ…ç»ªè¡¨è¾¾ - æƒ…æ„Ÿå¼ºåº¦å’Œç±»å‹
3. èŠ‚å¥æ„Ÿ - è¯­é€Ÿã€åœé¡¿ã€éŸµå¾‹
4. æç¬‘æ½œåŠ› - è¯¯è§£ç©ºé—´ã€åå·®æ•ˆæœ
5. æ­é…å¯èƒ½ - ä¸å…¶ä»–ç´ æçš„ç»„åˆæ½œåŠ›
                    </p>
                  </div>
                  
                  {/* ç”¨æˆ·æç¤ºè¯ */}
                  <div 
                    className="p-4 bg-[#1a1a1a] rounded-xl cursor-pointer hover:bg-[#1f1f1f] transition-colors"
                    onClick={() => setShowPromptPreview(showPromptPreview === 'user' ? null : 'user')}
                  >
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-xs text-gray-500">ç”¨æˆ·æç¤ºè¯æ¨¡æ¿</span>
                      <button className="text-[10px] px-2 py-0.5 rounded bg-purple-500/20 text-purple-400 hover:bg-purple-500/30 transition-colors">
                        {showPromptPreview === 'user' ? 'æ”¶èµ·' : 'å±•å¼€é¢„è§ˆ'}
                      </button>
                    </div>
                    <p className={`text-sm text-gray-300 ${showPromptPreview === 'user' ? '' : 'line-clamp-3'}`}>
                      åˆ†æä»¥ä¸‹å°è¯çš„æ··å‰ªåˆ›ä½œæ½œåŠ›ã€‚è¯·è¿”å› JSON æ ¼å¼ï¼ŒåŒ…å«ï¼š
- primary_function: æ ¸å¿ƒåŠŸèƒ½æ ‡ç­¾ï¼ˆå¦‚ï¼šå¼ºè¡Œè§£é‡Šã€èº«ä»½åè½¬ç­‰ï¼‰
- style_effects: é£æ ¼æ•ˆæœæ ‡ç­¾
- connection_type: è¿æ¥æ–¹å¼ï¼ˆå¦‚ï¼šæ¥åè½¬ã€æ¥åæ§½ç­‰ï¼‰
- editing_rhythm: å‰ªè¾‘èŠ‚å¥å»ºè®®
- sound_effect: éŸ³æ•ˆå¤„ç†å»ºè®®
- mashup_score: æ··å‰ªæ½œåŠ›è¯„åˆ†ï¼ˆ1-10ï¼‰
- usage_scenarios: ä½¿ç”¨åœºæ™¯æè¿°

å°è¯å†…å®¹ï¼š{"{subtitle_text}"}
                    </p>
                  </div>
                </div>
              </SettingsSection>
              
              {/* æ··å‰ªæ ‡ç­¾ä½“ç³» */}
              <SettingsSection
                title="æ··å‰ªæ ‡ç­¾ä½“ç³»"
                icon={<Tag size={18} />}
                description="è‡ªå®šä¹‰ç”¨äºå°è¯åˆ†ç±»çš„æ ‡ç­¾åº“"
              >
                <div className="space-y-4">
                  <div className="flex items-center gap-2 text-xs text-gray-500">
                    <Info size={12} />
                    <span>å½“å‰ç‰ˆæœ¬: {mashupConfig.version}</span>
                  </div>
                  
                  {tagCategories.map(({ key, label, color }) => (
                    <div key={key} className="p-4 bg-[#1a1a1a] rounded-xl">
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-2">
                          <span className="text-sm font-medium text-white">{label}</span>
                          <span className={`text-[10px] px-1.5 py-0.5 rounded bg-${color}-500/20 text-${color}-400`}>
                            {(mashupConfig[key] as string[])?.length || 0} ä¸ª
                          </span>
                        </div>
                        <button
                          onClick={() => setEditingTagCategory(editingTagCategory === key ? null : key)}
                          className="text-xs text-blue-400 hover:text-blue-300"
                        >
                          {editingTagCategory === key ? 'å®Œæˆ' : 'ç¼–è¾‘'}
                        </button>
                      </div>
                      
                      <div className="flex flex-wrap gap-2">
                        {(mashupConfig[key] as string[])?.map((tag, idx) => (
                          <span 
                            key={idx}
                            className={`inline-flex items-center gap-1 px-2 py-1 text-xs rounded-lg bg-${color}-500/10 text-${color}-300 border border-${color}-500/20`}
                          >
                            {tag}
                            {editingTagCategory === key && (
                              <button
                                onClick={() => handleRemoveTag(key, tag)}
                                className="ml-1 hover:text-red-400"
                              >
                                <X size={10} />
                              </button>
                            )}
                          </span>
                        ))}
                        
                        {editingTagCategory === key && (
                          <div className="flex items-center gap-1">
                            <input
                              type="text"
                              value={newTag}
                              onChange={(e) => setNewTag(e.target.value)}
                              onKeyDown={(e) => e.key === 'Enter' && handleAddTag(key)}
                              placeholder="æ–°æ ‡ç­¾..."
                              className="w-24 px-2 py-1 text-xs bg-[#0d0d0d] border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-blue-500"
                            />
                            <button
                              onClick={() => handleAddTag(key)}
                              className="p-1 bg-blue-600 hover:bg-blue-500 rounded text-white"
                            >
                              <Plus size={12} />
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </SettingsSection>
              
              <div className="p-4 bg-blue-500/5 border border-blue-500/10 rounded-xl">
                <div className="flex items-start gap-3">
                  <Info size={16} className="text-blue-400 shrink-0 mt-0.5" />
                  <div className="text-xs text-gray-400 space-y-2">
                    <p><strong className="text-gray-300">é…ç½®æ–‡ä»¶ä½ç½®ï¼š</strong><code className="bg-white/5 px-1.5 py-0.5 rounded text-blue-400">config/mashup_optimized_config.json</code></p>
                    <p><strong className="text-gray-300">æç¤ºï¼š</strong>æ ‡ç­¾ä½“ç³»ä¼šå½±å“ AI åˆ†æç»“æœçš„åˆ†ç±»ï¼Œæ·»åŠ æˆ–åˆ é™¤æ ‡ç­¾åä¸‹æ¬¡æ ‡æ³¨ç”Ÿæ•ˆ</p>
                  </div>
                </div>
              </div>
            </>
          )}
          
          {/* ========== ç³»ç»Ÿè®¾ç½® ========== */}
          {activeTab === 'system' && (
            <>
              <div>
                <h2 className="text-2xl font-bold text-white">ç³»ç»Ÿè®¾ç½®</h2>
                <p className="text-sm text-gray-500 mt-1">åº”ç”¨ç¨‹åºçš„é€šç”¨é…ç½®</p>
              </div>
              
              <SettingsSection
                title="å­˜å‚¨è·¯å¾„"
                icon={<FolderOpen size={18} />}
              >
                <div className="space-y-4">
                  {Object.entries(pathConfig).map(([key, value]) => (
                    <div key={key} className="flex items-center gap-4">
                      <span className="w-32 text-sm text-gray-400">
                        {key === 'media_root' && 'åª’ä½“æ ¹ç›®å½•'}
                        {key === 'annotations_dir' && 'æ ‡æ³¨ç›®å½•'}
                        {key === 'vectors_dir' && 'å‘é‡ç›®å½•'}
                        {key === 'cache_dir' && 'ç¼“å­˜ç›®å½•'}
                        {key === 'posters_dir' && 'æµ·æŠ¥ç›®å½•'}
                      </span>
                      <input
                        type="text"
                        value={value}
                        readOnly
                        className="flex-1 px-3 py-2 bg-[#1a1a1a] border border-white/10 rounded-lg text-sm text-gray-300 focus:outline-none"
                      />
                      <button 
                        onClick={() => handleSelectFolder(key)}
                        className="p-2 bg-white/5 hover:bg-white/10 rounded-lg transition-colors"
                        title="é€‰æ‹©æ–‡ä»¶å¤¹"
                      >
                        <FolderOpen size={16} className="text-gray-400" />
                      </button>
                    </div>
                  ))}
                </div>
              </SettingsSection>
              
              <SettingsSection
                title="åº”ç”¨åå¥½"
                icon={<Globe size={18} />}
              >
                <div className="space-y-4">
                  <label className="flex items-center justify-between p-3 bg-[#1a1a1a] rounded-xl cursor-pointer hover:bg-[#1f1f1f] transition-colors">
                    <div>
                      <span className="text-sm text-white">è‡ªåŠ¨ä¿å­˜</span>
                      <p className="text-xs text-gray-500 mt-0.5">è‡ªåŠ¨ä¿å­˜æ ‡æ³¨è¿›åº¦</p>
                    </div>
                    <div className={`w-12 h-6 rounded-full transition-colors ${appSettings.autoSave ? 'bg-blue-500' : 'bg-gray-600'}`}>
                      <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform ${appSettings.autoSave ? 'translate-x-6' : 'translate-x-0.5'} translate-y-0.5`} />
                    </div>
                  </label>
                  
                  <label className="flex items-center justify-between p-3 bg-[#1a1a1a] rounded-xl cursor-pointer hover:bg-[#1f1f1f] transition-colors">
                    <div>
                      <span className="text-sm text-white">åˆ é™¤å‰ç¡®è®¤</span>
                      <p className="text-xs text-gray-500 mt-0.5">åˆ é™¤å½±ç‰‡å‰æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†</p>
                    </div>
                    <div className={`w-12 h-6 rounded-full transition-colors ${appSettings.confirmBeforeDelete ? 'bg-blue-500' : 'bg-gray-600'}`}>
                      <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform ${appSettings.confirmBeforeDelete ? 'translate-x-6' : 'translate-x-0.5'} translate-y-0.5`} />
                    </div>
                  </label>
                  
                  <label className="flex items-center justify-between p-3 bg-[#1a1a1a] rounded-xl cursor-pointer hover:bg-[#1f1f1f] transition-colors">
                    <div>
                      <span className="text-sm text-white">æ˜¾ç¤ºæç¤º</span>
                      <p className="text-xs text-gray-500 mt-0.5">æ˜¾ç¤ºæ“ä½œæç¤ºå’Œå¸®åŠ©ä¿¡æ¯</p>
                    </div>
                    <div className={`w-12 h-6 rounded-full transition-colors ${appSettings.showTips ? 'bg-blue-500' : 'bg-gray-600'}`}>
                      <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform ${appSettings.showTips ? 'translate-x-6' : 'translate-x-0.5'} translate-y-0.5`} />
                    </div>
                  </label>
                </div>
              </SettingsSection>
              
              <SettingsSection
                title="å…³äº"
                icon={<Info size={18} />}
              >
                <div className="flex items-center gap-4">
                  <div className="w-16 h-16 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-blue-500/20">
                    CG
                  </div>
                  <div>
                    <h4 className="text-lg font-bold text-white">CineGraph-AI</h4>
                    <p className="text-sm text-gray-400">ç‰ˆæœ¬ 1.0.0-beta</p>
                    <p className="text-xs text-gray-500 mt-1">åŸºäºè¯­ä¹‰ç†è§£çš„æ™ºèƒ½å½±è§†æ··å‰ªå·¥å…·</p>
                  </div>
                </div>
              </SettingsSection>
            </>
          )}
        </div>
      </main>
      
      {/* æ¨¡å‹æä¾›è€…ç¼–è¾‘å¼¹çª— */}
      {showProviderEditor && editingProvider && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-8">
          <div className="bg-[#181818] rounded-2xl border border-white/10 w-full max-w-[600px] max-h-[85vh] flex flex-col shadow-2xl">
            <div className="flex items-center justify-between px-6 py-4 border-b border-white/10 shrink-0">
              <div className="flex items-center gap-3">
                {providerEditorCategory === 'llm' ? <Cpu size={20} className="text-blue-400" /> : <Sparkles size={20} className="text-purple-400" />}
                <h2 className="text-lg font-semibold text-white">
                  {editingProvider.id ? 'ç¼–è¾‘æ¨¡å‹' : 'æ·»åŠ æ¨¡å‹'}
                </h2>
              </div>
              <button onClick={() => setShowProviderEditor(false)} className="p-2 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white transition-colors">
                <X size={18} />
              </button>
            </div>
            
            <div className="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar">
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-1.5">
                  <label className="text-xs text-gray-500">åç§° *</label>
                  <input type="text" value={editingProvider.name || ''} onChange={e => setEditingProvider({...editingProvider, name: e.target.value})}
                    className="w-full px-3 py-2 bg-[#0d0d0d] border border-white/10 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500" placeholder="å¦‚ï¼šDeepSeek-V3" />
                </div>
                <div className="space-y-1.5">
                  <label className="text-xs text-gray-500">ç±»å‹</label>
                  <select value={editingProvider.provider_type || 'commercial'} onChange={e => setEditingProvider({...editingProvider, provider_type: e.target.value as any})}
                    className="w-full px-3 py-2 bg-[#0d0d0d] border border-white/10 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500">
                    <option value="local">æœ¬åœ°æ¨¡å‹</option>
                    <option value="commercial">å•†ç”¨ API</option>
                  </select>
                </div>
              </div>
              
              {editingProvider.provider_type === 'local' && (
                <div className="space-y-1.5">
                  <label className="text-xs text-gray-500">è¿è¡Œæ–¹å¼</label>
                  <select value={editingProvider.local_mode || 'ollama'} onChange={e => setEditingProvider({...editingProvider, local_mode: e.target.value})}
                    className="w-full px-3 py-2 bg-[#0d0d0d] border border-white/10 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500">
                    <option value="ollama">Ollama</option>
                    <option value="docker">Docker</option>
                    <option value="native">Python åŸç”Ÿ</option>
                  </select>
                </div>
              )}
              
              <div className="space-y-1.5">
                <label className="text-xs text-gray-500">API åœ°å€ *</label>
                <input type="text" value={editingProvider.base_url || ''} onChange={e => setEditingProvider({...editingProvider, base_url: e.target.value})}
                  className="w-full px-3 py-2 bg-[#0d0d0d] border border-white/10 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500" placeholder="å¦‚ï¼šhttps://api.deepseek.com/v1" />
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-1.5">
                  <label className="text-xs text-gray-500">æ¨¡å‹åç§°</label>
                  <input type="text" value={editingProvider.model || ''} onChange={e => setEditingProvider({...editingProvider, model: e.target.value})}
                    className="w-full px-3 py-2 bg-[#0d0d0d] border border-white/10 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500" placeholder="å¦‚ï¼šdeepseek-chat" />
                </div>
                <div className="space-y-1.5">
                  <label className="text-xs text-gray-500">API è°ƒç”¨é£æ ¼</label>
                  <select value={editingProvider.api_style || 'openai'} onChange={e => setEditingProvider({...editingProvider, api_style: e.target.value})}
                    className="w-full px-3 py-2 bg-[#0d0d0d] border border-white/10 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500">
                    <option value="openai">OpenAI å…¼å®¹</option>
                    <option value="ollama">Ollama åŸç”Ÿ</option>
                  </select>
                </div>
              </div>
              
              {editingProvider.provider_type === 'commercial' && (
                <div className="space-y-1.5">
                  <label className="text-xs text-gray-500">API Key</label>
                  <input type="password" value={editingProvider.api_key || ''} onChange={e => setEditingProvider({...editingProvider, api_key: e.target.value})}
                    className="w-full px-3 py-2 bg-[#0d0d0d] border border-white/10 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500" placeholder="è¾“å…¥ API Key æˆ–ç¯å¢ƒå˜é‡åï¼ˆå¦‚ DEEPSEEK_API_KEYï¼‰" />
                </div>
              )}
              
              {providerEditorCategory === 'llm' && (
                <div className="grid grid-cols-3 gap-4">
                  <div className="space-y-1.5">
                    <label className="text-xs text-gray-500">æœ€å¤§ Tokens</label>
                    <input type="number" value={editingProvider.max_tokens || 2000} onChange={e => setEditingProvider({...editingProvider, max_tokens: parseInt(e.target.value)})}
                      className="w-full px-3 py-2 bg-[#0d0d0d] border border-white/10 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500" />
                  </div>
                  <div className="space-y-1.5">
                    <label className="text-xs text-gray-500">Temperature</label>
                    <input type="number" step="0.1" min="0" max="2" value={editingProvider.temperature || 0.7} onChange={e => setEditingProvider({...editingProvider, temperature: parseFloat(e.target.value)})}
                      className="w-full px-3 py-2 bg-[#0d0d0d] border border-white/10 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500" />
                  </div>
                  <div className="space-y-1.5">
                    <label className="text-xs text-gray-500">è¶…æ—¶ (ç§’)</label>
                    <input type="number" value={editingProvider.timeout || 60} onChange={e => setEditingProvider({...editingProvider, timeout: parseInt(e.target.value)})}
                      className="w-full px-3 py-2 bg-[#0d0d0d] border border-white/10 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500" />
                  </div>
                </div>
              )}
              
              {providerEditorCategory === 'embedding' && (
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-1.5">
                    <label className="text-xs text-gray-500">å‘é‡ç»´åº¦</label>
                    <input type="number" value={editingProvider.dimension || 1024} onChange={e => setEditingProvider({...editingProvider, dimension: parseInt(e.target.value)})}
                      className="w-full px-3 py-2 bg-[#0d0d0d] border border-white/10 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500" />
                  </div>
                  <div className="space-y-1.5">
                    <label className="text-xs text-gray-500">è¶…æ—¶ (ç§’)</label>
                    <input type="number" value={editingProvider.timeout || 60} onChange={e => setEditingProvider({...editingProvider, timeout: parseInt(e.target.value)})}
                      className="w-full px-3 py-2 bg-[#0d0d0d] border border-white/10 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500" />
                  </div>
                </div>
              )}
              
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-1.5">
                  <label className="text-xs text-gray-500">æè¿°</label>
                  <input type="text" value={editingProvider.description || ''} onChange={e => setEditingProvider({...editingProvider, description: e.target.value})}
                    className="w-full px-3 py-2 bg-[#0d0d0d] border border-white/10 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500" placeholder="ç®€çŸ­æè¿°" />
                </div>
                <div className="space-y-1.5">
                  <label className="text-xs text-gray-500">ä»·æ ¼ä¿¡æ¯</label>
                  <input type="text" value={editingProvider.price_info || ''} onChange={e => setEditingProvider({...editingProvider, price_info: e.target.value})}
                    className="w-full px-3 py-2 bg-[#0d0d0d] border border-white/10 rounded-lg text-sm text-white focus:outline-none focus:border-blue-500" placeholder="å¦‚ï¼šÂ¥0.5/1M tokens" />
                </div>
              </div>
            </div>
            
            <div className="flex items-center justify-between px-6 py-4 border-t border-white/10 shrink-0">
              <button onClick={() => setShowProviderEditor(false)} className="px-4 py-2 text-sm text-gray-400 hover:text-white transition-colors">å–æ¶ˆ</button>
              <button onClick={handleSaveProvider} disabled={isSaving}
                className="flex items-center gap-2 px-6 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-700 rounded-xl text-white text-sm font-medium transition-colors">
                {isSaving ? <Loader2 size={14} className="animate-spin" /> : <Save size={14} />}
                {editingProvider.id ? 'ä¿å­˜ä¿®æ”¹' : 'åˆ›å»ºæ¨¡å‹'}
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* é…ç½®ç¼–è¾‘å™¨æ¨¡æ€æ¡† - å¢å¤§é«˜åº¦ */}
      {showConfigEditor && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-8">
          <div className="bg-[#181818] rounded-2xl border border-white/10 w-full max-w-[1000px] h-[90vh] flex flex-col shadow-2xl">
            {/* æ ‡é¢˜æ  */}
            <div className="flex items-center justify-between px-6 py-4 border-b border-white/10 shrink-0">
              <div className="flex items-center gap-3">
                {configEditorType === 'llm' && <Cpu size={20} className="text-blue-400" />}
                {configEditorType === 'embedding' && <Sparkles size={20} className="text-purple-400" />}
                {configEditorType === 'vectordb' && <Database size={20} className="text-green-400" />}
                {configEditorType === 'prompt' && <FileText size={20} className="text-orange-400" />}
                {configEditorType === 'mashup' && <Tag size={20} className="text-pink-400" />}
                <div>
                  <h2 className="text-lg font-semibold text-white">
                    {configEditorType === 'llm' && 'LLM æä¾›è€…é…ç½®'}
                    {configEditorType === 'embedding' && 'Embedding æ¨¡å‹é…ç½®'}
                    {configEditorType === 'vectordb' && 'å‘é‡æ•°æ®åº“é…ç½®'}
                    {configEditorType === 'prompt' && 'æç¤ºè¯é…ç½®'}
                    {configEditorType === 'mashup' && 'æ··å‰ªæ ‡ç­¾é…ç½®'}
                  </h2>
                  <p className="text-xs text-gray-500">
                    {configEditorType === 'llm' && 'config/llm_providers.yaml'}
                    {configEditorType === 'embedding' && 'config/llm_providers.yaml (embedding éƒ¨åˆ†)'}
                    {configEditorType === 'vectordb' && 'config/llm_providers.yaml (vectordb éƒ¨åˆ†)'}
                    {configEditorType === 'prompt' && 'config/prompt_config.json'}
                    {configEditorType === 'mashup' && 'config/mashup_optimized_config.json'}
                  </p>
                </div>
              </div>
              <button
                onClick={() => setShowConfigEditor(false)}
                className="p-2 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white transition-colors"
              >
                <X size={18} />
              </button>
            </div>
            
            {/* ç¼–è¾‘å™¨ - å æ»¡å‰©ä½™ç©ºé—´ */}
            <div className="flex-1 overflow-hidden p-4 min-h-0">
              <textarea
                value={configEditorContent}
                onChange={(e) => setConfigEditorContent(e.target.value)}
                className="w-full h-full bg-[#0d0d0d] border border-white/10 rounded-xl p-4 text-sm text-gray-200 font-mono resize-none focus:outline-none focus:border-blue-500 custom-scrollbar"
                spellCheck={false}
              />
            </div>
            
            {/* åº•éƒ¨ */}
            <div className="flex items-center justify-between px-6 py-4 border-t border-white/10 bg-[#151515] shrink-0">
              <p className="text-xs text-gray-500">
                {(configEditorType === 'llm' || configEditorType === 'embedding' || configEditorType === 'vectordb') && 'ä¿®æ”¹åéœ€è¦é‡æ–°åŠ è½½é…ç½®ä»¥ç”Ÿæ•ˆ'}
                {configEditorType === 'prompt' && 'æç¤ºè¯é…ç½®ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆ'}
                {configEditorType === 'mashup' && 'æ ‡ç­¾é…ç½®ä¿®æ”¹åä¸‹æ¬¡æ ‡æ³¨ç”Ÿæ•ˆ'}
              </p>
              <div className="flex items-center gap-3">
                <button
                  onClick={() => setShowConfigEditor(false)}
                  className="px-4 py-2 text-sm text-gray-400 hover:text-white transition-colors"
                >
                  å–æ¶ˆ
                </button>
                <button
                  onClick={handleSaveConfig}
                  disabled={isSaving}
                  className={`flex items-center gap-2 px-4 py-2 text-white text-sm font-medium rounded-xl transition-colors ${
                    configEditorType === 'llm' || configEditorType === 'embedding' || configEditorType === 'vectordb'
                      ? 'bg-blue-600 hover:bg-blue-500 disabled:bg-gray-700'
                      : configEditorType === 'prompt'
                        ? 'bg-purple-600 hover:bg-purple-500 disabled:bg-gray-700'
                        : 'bg-green-600 hover:bg-green-500 disabled:bg-gray-700'
                  }`}
                >
                  {isSaving ? (
                    <>
                      <Loader2 size={14} className="animate-spin" />
                      ä¿å­˜ä¸­...
                    </>
                  ) : (
                    <>
                      <Save size={14} />
                      ä¿å­˜é…ç½®
                    </>
                  )}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
