<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>豆瓣</title>
    <style type="text/css">
        body{font-family:Arial,Helvetica,sans-serif;font-size:14px;}
    </style>
</head>
<body>
    <div>
        <div style="margin:20px auto;">
            <div style="font-size:25px;color:#1b9336;border-bottom:5px solid #eef9eb">
                <span style="font-size:20px;font-weight:bold">豆瓣</span> d<span style="color:#0092c8">o</span><span style="color:#ffad68">u</span><span>b</span><span style="color:#0092c8">a</span><span style="color:#ffad68">n</span>
            </div>
            <p>载入中 ...</p>
            <form name="sec" id="sec" method="POST" action="/c">
              <input type="hidden" id="tok" name="tok" value="1769781932@60c78214a8f0c3bc6e5822a70132dabea930750fdd51643466f234863fb3e6e0184ef431b364cc4aff371d78dea25220ed48d8cbecf493277732d9237b092d17@aHR0cHM6Ly9tb3ZpZS5kb3ViYW4uY29tL3N1YmplY3QvMjU3MTcyMzMvY2VsZWJyaXRpZXM=@8d3e16ea069f5efb3b1e37841c24e46a69b42037588ecd618e98d68f03f4d52f" />
              <input type="hidden" id="cha" name="cha" value="bd31f9ea7bfe5d009ae7def2353333f3211d23792d83824eaf5939b5f12d55da397f89da425253ecd039acfad04b636dc78f7cd2288efe7d4807a6526de86882" />
              <input type="hidden" id="sol" name="sol" value="" />
              <input type="hidden" id="red" name="red" value="https://movie.douban.com/subject/25717233/celebrities">
            </form>
        </div>
    </div>
</body>
<script>

function sha512(string) {
    return new Promise((resolve, reject) => {
        let buffer = (new TextEncoder).encode(string);

        crypto.subtle.digest('SHA-512', buffer.buffer).then(result => {
            resolve(Array.from(new Uint8Array(result)).map(
                c => c.toString(16).padStart(2, '0')
            ).join(''));
        }, reject);
    });
}

async function process(data, difficulty = 4) {
    let hash;
    let nonce = 0;
    const targetSubStr = Array(difficulty+1).join('0');

    do {
        nonce += 1;
        hash = await sha512(data + nonce);
    } while(hash.substr(0, difficulty) !== targetSubStr);
    return nonce;
}

async function run(e) {
    e.preventDefault();
    const tok = document.querySelector("#tok").value;
    const cha = document.querySelector("#cha").value;
    let f = document.querySelector("#sol");
    let s = await process(cha);
    f.value = s;
    e.target.submit();
}

window.addEventListener("load", function chk(e) {
    const sub = document.querySelector("#sec");
    sub.addEventListener("submit", run);
    setTimeout(() => { sub.requestSubmit(); }, 500);
})
</script>
</html>

