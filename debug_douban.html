<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>豆瓣</title>
    <style type="text/css">
        body{font-family:Arial,Helvetica,sans-serif;font-size:14px;}
    </style>
</head>
<body>
    <div>
        <div style="margin:20px auto;">
            <div style="font-size:25px;color:#1b9336;border-bottom:5px solid #eef9eb">
                <span style="font-size:20px;font-weight:bold">豆瓣</span> d<span style="color:#0092c8">o</span><span style="color:#ffad68">u</span><span>b</span><span style="color:#0092c8">a</span><span style="color:#ffad68">n</span>
            </div>
            <p>载入中 ...</p>
            <form name="sec" id="sec" method="POST" action="/c">
              <input type="hidden" id="tok" name="tok" value="1769781888@9218505f4ed2dc2c6bce1f567129991e21e5eb47fef85542eabbeeb867c338529d26c64b652ba120f33032f4757dac8532ce4365efee4ecf3374217e30b5d1e1@aHR0cHM6Ly9tb3ZpZS5kb3ViYW4uY29tL3N1YmplY3QvMjU3MTcyMzMv@8d3e16ea069f5efb3b1e37841c24e46a69b42037588ecd618e98d68f03f4d52f" />
              <input type="hidden" id="cha" name="cha" value="77e666c2e36a394765b443a26f07017322ccbb638cf72d07a1249ad13c1169f65d8905a9e925f7b7326d187e9d6d882e1358d4cf8bd703a053d54b2fca0dc11e" />
              <input type="hidden" id="sol" name="sol" value="" />
              <input type="hidden" id="red" name="red" value="https://movie.douban.com/subject/25717233/">
            </form>
        </div>
    </div>
</body>
<script>

function sha512(string) {
    return new Promise((resolve, reject) => {
        let buffer = (new TextEncoder).encode(string);

        crypto.subtle.digest('SHA-512', buffer.buffer).then(result => {
            resolve(Array.from(new Uint8Array(result)).map(
                c => c.toString(16).padStart(2, '0')
            ).join(''));
        }, reject);
    });
}

async function process(data, difficulty = 4) {
    let hash;
    let nonce = 0;
    const targetSubStr = Array(difficulty+1).join('0');

    do {
        nonce += 1;
        hash = await sha512(data + nonce);
    } while(hash.substr(0, difficulty) !== targetSubStr);
    return nonce;
}

async function run(e) {
    e.preventDefault();
    const tok = document.querySelector("#tok").value;
    const cha = document.querySelector("#cha").value;
    let f = document.querySelector("#sol");
    let s = await process(cha);
    f.value = s;
    e.target.submit();
}

window.addEventListener("load", function chk(e) {
    const sub = document.querySelector("#sec");
    sub.addEventListener("submit", run);
    setTimeout(() => { sub.requestSubmit(); }, 500);
})
</script>
</html>

